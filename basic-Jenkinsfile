def runStuff(String nodeName, Map info)
{
    println("runstuff: ${nodeName}")
    node("${nodeName}") {
	stage("do it on ${nodeName}") {
	    println("${env.NODE_NAME}")
	}
    }
    println("end")
}

def buildRun(Map info)
{
    def runmap = [:]
    allnodes = getAllNodes()
    for (i=0; i<allnodes.size(); i++) {
	def agentName = allnodes[i]
	runmap[agentName] = {
	    runStuff(agentName, info)
	}
    }
    return runmap
}

pipeline {
    agent { label 'built-in' }

    stages {
	stage('info') {
	    steps {
		script {
		    info = ['test':'value']
		}
	    }
	}
	// This is the main stage that covers everything
	stage('go') {
	    steps {
		script {
		    map = buildRun(info)
		    println(map)
		    parallel map
		}
	    }
	}
    }
}
